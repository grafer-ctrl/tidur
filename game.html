<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Meta Viewport Penting agar Canvas Fullscreen dan tidak bisa di-zoom -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#0f172a">
  <title>Sleep Game Canvas</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* Reset Total */
    * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

    html, body {
      width: 100%; height: 100%;
      background: #0f172a;
      overflow: hidden; /* Mencegah scroll bar muncul */
      font-family: 'Inter', sans-serif;
      position: fixed; /* Kunci body agar tidak goyang di Android */
    }

    /* Canvas Game Layer */
    #gameCanvas {
      display: block;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 50% 100%, #1e1b4b, #020617);
      touch-action: none; /* Mematikan gesture zoom/scroll browser */
    }

    /* UI Layer (Di atas Canvas) */
    #ui-layer {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none; /* Agar klik tembus ke canvas */
      display: flex; flex-direction: column;
    }

    header {
      padding: 1.5rem; text-align: center; pointer-events: auto;
    }
    
    h1 {
      font-size: 1.5rem; font-weight: 700;
      background: linear-gradient(to right, #a78bfa, #818cf8);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }
    
    .score-board {
      font-size: 3rem; font-weight: 700; color: rgba(255,255,255,0.2);
      margin-top: 0.5rem; transition: transform 0.1s;
    }

    .btn-music {
      position: absolute; top: 1.5rem; right: 1.5rem;
      width: 44px; height: 44px; border-radius: 50%;
      background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1);
      color: white; font-size: 1.2rem; cursor: pointer;
      pointer-events: auto; display: flex; align-items: center; justify-content: center;
      backdrop-filter: blur(5px);
    }

    /* Start Screen Overlay */
    #startScreen {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(15, 23, 42, 0.85);
      backdrop-filter: blur(10px);
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
      pointer-events: auto; z-index: 50;
      transition: opacity 0.3s;
    }
    #startScreen.hidden { opacity: 0; pointer-events: none; }

    .btn-start {
      background: #818cf8; color: #0f172a; border: none;
      padding: 1rem 3rem; font-size: 1.2rem; font-weight: 700;
      border-radius: 50px; cursor: pointer;
      box-shadow: 0 0 25px rgba(129, 140, 248, 0.6);
    }
    .btn-start:active { transform: scale(0.95); }

    /* Bottom Nav */
    .bottom-nav {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      width: 90%; max-width: 350px;
      background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.1); padding: 10px 0;
      border-radius: 50px; display: flex; justify-content: space-evenly;
      z-index: 100; pointer-events: auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    .nav-item {
      color: #94a3b8; text-decoration: none;
      display: flex; flex-direction: column; align-items: center;
      font-size: 0.7rem; width: 60px;
    }
    .nav-item.active { color: #818cf8; }
    .nav-icon { font-size: 1.4rem; margin-bottom: 2px; }

  </style>
</head>
<body>

  <!-- Audio Hujan -->
  <audio id="rainAudio" loop src="https://actions.google.com/sounds/v1/weather/rain_heavy_loud.ogg"></audio>

  <!-- 1. CANVAS LAYER (GAME) -->
  <canvas id="gameCanvas"></canvas>

  <!-- 2. UI LAYER (HUD) -->
  <div id="ui-layer">
    <header>
      <h1>Dreamy Catch</h1>
      <div class="score-board" id="scoreDisplay">0</div>
      <button class="btn-music" id="musicBtn" onclick="toggleMusic()">üîá</button>
    </header>

    <!-- Start Overlay -->
    <div id="startScreen">
      <div style="font-size: 5rem; margin-bottom: 1rem; filter: drop-shadow(0 0 20px rgba(255,255,255,0.2));">üåô</div>
      <p style="color: #94a3b8; margin-bottom: 2rem;">Tap floating items to relax</p>
      <button class="btn-start" onclick="startGame()">PLAY</button>
    </div>

    <!-- Bottom Nav -->
    <nav class="bottom-nav">
      <a href="index.html" class="nav-item">
        <span class="nav-icon">üè†</span><span>Home</span>
      </a>
      <a href="music.html" class="nav-item">
        <span class="nav-icon">üéµ</span><span>Music</span>
      </a>
      <a href="game.html" class="nav-item active">
        <span class="nav-icon">üéÆ</span><span>Game</span>
      </a>
    </nav>
  </div>

  <script>
    // --- SETUP CANVAS ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // UI Elements
    const scoreDisplay = document.getElementById('scoreDisplay');
    const startScreen = document.getElementById('startScreen');
    const rainAudio = document.getElementById('rainAudio');
    const musicBtn = document.getElementById('musicBtn');

    // Game Variables
    let width, height;
    let items = [];
    let score = 0;
    let gameActive = false;
    let lastTime = 0;
    let spawnTimer = 0;
    
    // Assets (Emojis)
    const emojis = ['üçå', '‚≠ê', 'üåô', 'üí§', '‚òÅÔ∏è'];

    // Audio Setup
    rainAudio.volume = 0.3;
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    // --- RESIZE FUNCTION (CRITICAL FOR ANDROID) ---
    function resize() {
      width = window.innerWidth;
      height = window.innerHeight;
      canvas.width = width;
      canvas.height = height;
    }
    window.addEventListener('resize', resize);
    resize(); // Call immediately

    // --- GAME LOGIC ---
    class Item {
      constructor() {
        this.text = emojis[Math.floor(Math.random() * emojis.length)];
        this.size = Math.random() * 40 + 40; // Ukuran 40px - 80px
        this.x = Math.random() * (width - 100) + 50;
        this.y = height + 100; // Start below screen
        this.speed = Math.random() * 1.5 + 0.5; // Slow speed
        this.angle = 0;
        this.spinSpeed = (Math.random() - 0.5) * 0.02;
        this.popped = false;
        this.popScale = 1;
        this.opacity = 1;
      }

      update() {
        if (this.popped) {
          this.popScale += 0.1;
          this.opacity -= 0.1;
        } else {
          this.y -= this.speed;
          this.angle += this.spinSpeed;
        }
      }

      draw(ctx) {
        if (this.opacity <= 0) return;
        
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.angle);
        ctx.scale(this.popped ? this.popScale : 1, this.popped ? this.popScale : 1);
        ctx.globalAlpha = this.opacity;
        
        ctx.font = `${this.size}px "Segoe UI Emoji", "Apple Color Emoji", sans-serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(this.text, 0, 0);
        
        ctx.restore();
      }
    }

    function gameLoop(timestamp) {
      if (!gameActive) return;

      const deltaTime = timestamp - lastTime;
      lastTime = timestamp;

      // Clear Canvas
      ctx.clearRect(0, 0, width, height);

      // Spawning
      spawnTimer += deltaTime;
      if (spawnTimer > 900) { // Spawn every 900ms
        items.push(new Item());
        spawnTimer = 0;
      }

      // Update & Draw Items
      for (let i = items.length - 1; i >= 0; i--) {
        let item = items[i];
        item.update();
        item.draw(ctx);

        // Remove if off screen or faded out
        if (item.y < -100 || item.opacity <= 0) {
          items.splice(i, 1);
        }
      }

      requestAnimationFrame(gameLoop);
    }

    // --- INPUT HANDLING (TOUCH) ---
    function handleTap(e) {
      if (!gameActive) return;
      
      // Get coordinates (support touch and mouse)
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;

      // Check collision
      for (let i = items.length - 1; i >= 0; i--) {
        let item = items[i];
        if (item.popped) continue;

        // Simple distance check (Hitbox)
        const dx = clientX - item.x;
        const dy = clientY - item.y;
        const dist = Math.sqrt(dx * dx + dy * dy);

        if (dist < item.size) { // Hit!
          item.popped = true;
          playPopSound();
          score++;
          scoreDisplay.textContent = score;
          
          // Efek visual score bounce
          scoreDisplay.style.transform = "scale(1.3)";
          setTimeout(() => scoreDisplay.style.transform = "scale(1)", 100);
          
          break; // Only pop one at a time
        }
      }
    }

    canvas.addEventListener('touchstart', handleTap, {passive: false});
    canvas.addEventListener('mousedown', handleTap);

    // --- CONTROLS ---
    function startGame() {
      gameActive = true;
      score = 0;
      scoreDisplay.textContent = 0;
      items = [];
      startScreen.classList.add('hidden');
      
      rainAudio.play().catch(e => console.log(e));
      musicBtn.textContent = 'üîä';
      
      if (audioCtx.state === 'suspended') audioCtx.resume();
      
      lastTime = performance.now();
      requestAnimationFrame(gameLoop);
    }

    function toggleMusic() {
      if (rainAudio.paused) {
        rainAudio.play();
        musicBtn.textContent = 'üîä';
      } else {
        rainAudio.pause();
        musicBtn.textContent = 'üîá';
      }
    }

    function playPopSound() {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(300 + Math.random() * 100, audioCtx.currentTime);
      gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.1);
    }

    // Pause when leaving app
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        gameActive = false;
        rainAudio.pause();
        musicBtn.textContent = 'üîá';
        startScreen.classList.remove('hidden');
      }
    });

  </script>
</body>
</html>
